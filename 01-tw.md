NIP-01 中文譯文
==============

通訊協定基本陳明
-------------

`草稿` `首要項` `作者:fiatjaf` `作者:distbit` `作者:scsibug` `作者:kukks` `作者:jb55`

本文規定一份適合讓任何人動手實作的通訊協定基礎。在本文提到的結構與流程裡，任何人可以添入新欄位，也可以補充新的訊息規格，也可以增添新的功能。

## 事件與簽章

每一使用者擁有一副密鑰：私鑰與公鑰。秘密簽章，公鑰與編碼的做法，皆符合[橢圓曲線 `secp256k1` 施諾爾簽章準則](https://bips.xyz/340)。

`事件`是唯一存在的物件型別。內有下列格式：

```json
{
  "id": 「 32 個位元組，以小寫 16 進制數字，表達將本事件主要欄位序列化的 sha256 文字」,
  "pubkey": 「 32 個位元組，以小寫 16 進制數字，表達事件發出人的公鑰」,
  "created_at": 「以秒為底的 UNIX 整數時間值」,
  "kind": 「一個整數」,
  "tags": [
    ["e", 「 32 個位元組，以 16 進制數字表達的另一個事件 id 值」, 「推薦的中繼站址」],
    ["p", 「 32 個位元組，以 16 進制數字表達的公鑰」, 「推薦的中繼站址」],
    ... // 之後還可以放許多個他種標籤
  ],
  "content": 「任何文字」,
  "sig": 「 64 個位元組，以 16 進制數字，表達將事件主要內容序列化之後的 sha256 雜湊碼再加以簽章值；即本事件 id 值的簽章值」
}
```

`事件 id 值`的算法是將事件給序列化，求 `sha256` 值。序列化手續，要先將下列 JSON 格式化為文字，去除全部的空白符號與換行符號，而變成 UTF-8 字串，然後才序列化。

```json
[
  0,
  「 pubkey ，以小寫 16 進制數字表示」,
  「 created_at ，以整數表示」,
  「 kind ，以整數表示」,
  「 tags ，以巢狀陣列表示；巢狀陣列最裡是一些字串，任何字串都不能是 null 」,
  「 content ，以字串表達」
]
```

## Communication between clients and relays

Relays expose a websocket endpoint to which clients can connect.

### From client to relay: sending events and creating subscriptions

Clients can send 3 types of messages, which must be JSON arrays, according to the following patterns:

  * `["EVENT", <event JSON as defined above>]`, used to publish events.
  * `["REQ", <subscription_id>, <filters JSON>...]`, used to request events and subscribe to new updates.
  * `["CLOSE", <subscription_id>]`, used to stop previous subscriptions.

`<subscription_id>` is a random string that should be used to represent a subscription.

`<filters>` is a JSON object that determines what events will be sent in that subscription, it can have the following attributes:

```json
{
  "ids": <a list of event ids or prefixes>,
  "authors": <a list of pubkeys or prefixes, the pubkey of an event must be one of these>,
  "kinds": <a list of a kind numbers>,
  "#e": <a list of event ids that are referenced in an "e" tag>,
  "#p": <a list of pubkeys that are referenced in a "p" tag>,
  "since": <an integer unix timestamp, events must be newer than this to pass>,
  "until": <an integer unix timestamp, events must be older than this to pass>,
  "limit": <maximum number of events to be returned in the initial query>
}
```

Upon receiving a `REQ` message, the relay SHOULD query its internal database and return events that match the filter, then store that filter and send again all future events it receives to that same websocket until the websocket is closed. The `CLOSE` event is received with the same `<subscription_id>` or a new `REQ` is sent using the same `<subscription_id>`, in which case it should overwrite the previous subscription.

Filter attributes containing lists (such as `ids`, `kinds`, or `#e`) are JSON arrays with one or more values.  At least one of the array's values must match the relevant field in an event for the condition itself to be considered a match.  For scalar event attributes such as `kind`, the attribute from the event must be contained in the filter list.  For tag attributes such as `#e`, where an event may have multiple values, the event and filter condition values must have at least one item in common.

The `ids` and `authors` lists contain lowercase hexadecimal strings, which may either be an exact 64-character match, or a prefix of the event value.  A prefix match is when the filter string is an exact string prefix of the event value.  The use of prefixes allows for more compact filters where a large number of values are queried, and can provide some privacy for clients that may not want to disclose the exact authors or events they are searching for.

All conditions of a filter that are specified must match for an event for it to pass the filter, i.e., multiple conditions are interpreted as `&&` conditions.

A `REQ` message may contain multiple filters. In this case, events that match any of the filters are to be returned, i.e., multiple filters are to be interpreted as `||` conditions.

The `limit` property of a filter is only valid for the initial query and can be ignored afterward. When `limit: n` is present it is assumed that the events returned in the initial query will be the latest `n` events. It is safe to return less events than `limit` specifies, but it is expected that relays do not return (much) more events than requested so clients don't get unnecessarily overwhelmed by data.

### From relay to client: sending events and notices

Relays can send 2 types of messages, which must also be JSON arrays, according to the following patterns:

  * `["EVENT", <subscription_id>, <event JSON as defined above>]`, used to send events requested by clients.
  * `["NOTICE", <message>]`, used to send human-readable error messages or other things to clients.

This NIP defines no rules for how `NOTICE` messages should be sent or treated.

`EVENT` messages MUST be sent only with a subscription ID related to a subscription previously initiated by the client (using the `REQ` message above).

## Basic Event Kinds

  - `0`: `set_metadata`: the `content` is set to a stringified JSON object `{name: <username>, about: <string>, picture: <url, string>}` describing the user who created the event. A relay may delete past `set_metadata` events once it gets a new one for the same pubkey.
  - `1`: `text_note`: the `content` is set to the text content of a note (anything the user wants to say). Non-plaintext notes should instead use kind 1000-10000 as described in [NIP-16](16.md).
  - `2`: `recommend_server`: the `content` is set to the URL (e.g., `wss://somerelay.com`) of a relay the event creator wants to recommend to its followers.

A relay may choose to treat different message kinds differently, and it may or may not choose to have a default way to handle kinds it doesn't know about.

## Other Notes:

- Clients should not open more than one websocket to each relay. One channel can support an unlimited number of subscriptions, so clients should do that.
- The `tags` array can store a tag identifier as the first element of each subarray, plus arbitrary information afterward (always as strings). This NIP defines `"p"` — meaning "pubkey", which points to a pubkey of someone that is referred to in the event —, and `"e"` — meaning "event", which points to the id of an event this event is quoting, replying to or referring to somehow.
- The `<recommended relay URL>` item present on the `"e"` and `"p"` tags is an optional (could be set to `""`) URL of a relay the client could attempt to connect to fetch the tagged event or other events from a tagged profile. It MAY be ignored, but it exists to increase censorship resistance and make the spread of relay addresses more seamless across clients.
