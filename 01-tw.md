NIP-01 中文譯文
==============

通訊協定基本陳明
-------------

`草稿` `首要項` `作者:fiatjaf` `作者:distbit` `作者:scsibug` `作者:kukks` `作者:jb55`

本文規定一份適合讓任何人動手實作的通訊協定基礎。在本文提到的結構與流程裡，任何人可以添入新欄位，也可以補充新的訊息規格，也可以增添新的功能。

## 事件與簽章

每一使用者擁有一副密鑰：私鑰與公鑰。秘密簽章，公鑰與編碼的做法，皆符合[橢圓曲線 `secp256k1` 施諾爾簽章準則](https://bips.xyz/340)。

`事件`是唯一存在的物件型別。內有下列格式：

```json
{
  "id": 「 32 個位元組，以小寫 16 進制數字，表達將本事件主要欄位序列化的 sha256 文字」,
  "pubkey": 「 32 個位元組，以小寫 16 進制數字，表達事件發出人的公鑰」,
  "created_at": 「以秒為底的 UNIX 整數時間值」,
  "kind": 「一個整數」,
  "tags": [
    ["e", 「 32 個位元組，以 16 進制數字表達的另一個事件 id 值」, 「推薦的中繼站址」],
    ["p", 「 32 個位元組，以 16 進制數字表達的公鑰」, 「推薦的中繼站址」],
    ... // 之後還可以放許多個他種標籤
  ],
  "content": 「任何文字」,
  "sig": 「 64 個位元組，以 16 進制數字，表達將事件主要內容序列化之後的 sha256 雜湊碼再加以簽章值；即本事件 id 值的簽章值」
}
```

`事件 id 值`的算法是將事件給序列化，求 `sha256` 值。序列化手續，要先將下列 JSON 格式化為文字，去除全部的空白符號與換行符號，而變成 UTF-8 字串，然後才序列化。

```json
[
  0,
  「 pubkey ，以小寫 16 進制數字表示」,
  「 created_at ，以整數表示」,
  「 kind ，以整數表示」,
  「 tags ，以巢狀陣列表示；巢狀陣列最裡是一些字串，任何字串都不能是 null 」,
  「 content ，以字串表達」
]
```

## 客戶端與中繼端溝通

中繼端釋出一個 websocket 接點，讓客戶端進行連線。

### 從客戶端連到中繼端：發送事件，並建立訊息訂閱。

客戶端能發送三種訊息，每一種訊息都必須是 JSON 陣列，並構成下列格式：

  * `["EVENT", 「上述 JSON 事件格式」]`，用來發送事件。
  * `["REQ", 「訊息訂閱代碼 subscription_id」, 「以 JSON 表達的多重過濾規則」...]`，用來索取事件並訂閱其更動。
  * `["CLOSE", 「訊息訂閱代碼 subscription_id」]`，用來解除先前的訂閱。

`訂閱訊息代碼 subscription_id`是一筆隨意文字，但該文字必須代表一次訂閱。

`多重過濾規則`是一個 JSON 物件，用來判定由該次訂閱該有哪些事件資料送回來。過濾規則有以下幾個欄位：

```json
{
  "ids": 「一列多個事件 id 或其前段文字」,
  "authors": 「一列多個 pubkey 或其前段文字；這列資料裡必須包含一個事件的 pubkey 」,
  "kinds": 「一列多個 kind 數值」,
  "#e": 「一列多個出現在 "e" 標籤裡的事件 id」,
  "#p": 「一列多個出現在 "p" 標籤裡的 pubkey 值」,
  "since": 「一個 UNIX 整數時間值，用來找出在該時間之後新的事件」,
  "until": 「一個 UNIX 整數時間值，用來找出在該時間之前舊有事件」,
  "limit": 「指在第一個資訊索取指令之後，會送回來的事件最大數目」
}
```

當中繼站收到任何一筆 `REQ` 訊息，都必須從其內部資料庫查閱相關事件資料，並返送回給客戶端。事件查閱須符合過濾規則，而中繼站會存儲該過濾規則，並將來只要在解除訂閱之前，中繼站會一直將新獲得的事件，只要符合該過濾規則，就一直轉送給訂閱方。而藉由同一個`訊息訂閱代碼 subscription_id` ，無論收到 `CLOSE` 訊息或再收到 `REQ` 訊息，都該更新到先前的訂閱。

多重過濾規則裡，有許多列狀的欄位，如 `ids`，`kinds` 和 `#e`，可以有一筆值，或包含多筆值。一列多筆值裡，一定至少有一筆比對並符合事件資料裡的對應欄位，這樣我們才說所找到的事件資料符合過濾規則。至於像 `kind` 那樣的單一值欄位，要事件資料裡的該欄位值，在過濾規則裡對應欄位的一列配對值裡找得到一筆符合。至於像 `#e` 那樣的欄位，任何一個事件資料裡可以有很多 `e` 標籤值，那麼，在事件裡的 `e` 標籤列表與在過濾規則裡的 `#e` 標籤列表，雙方要個別至少包含同一筆值。

`ids` 與 `authors` 列表包含多筆以 16 進制數字表達的文字，要嘛是 64 個字都完全匹配，或者，能匹配事件值的前段文字。前段文字匹配的意思，是指過濾規則的文字，就是事件欄位值的前段。動用到前段文字的概念，使過濾規則可以用比較短的欄位值，換得更多查詢結果，並且，能藉由較短的過濾值給客戶端保有一些隱私，讓它們的姓名欄位或事件資料不必定由於搜尋條件而徹底洩漏整段內容。

在一個多重過濾規則裡所下的條件都全部要比對並符合一個事件資料，而該事件才算是成立；也就是，那許多個條件之間的關係是 `&&` 關係。

`REQ` 訊息可以帶許多個過濾規則。當有許多個過濾規則時，能比對並符合任何一個過濾規則的事件都會收入查詢結果；也就是，許多個過濾規則之間的關係是 `||` 關係。

過濾規則的 `limit` 欄位只能在第一次 `REQ` 訊息裡使用；之後再出現同一個欄位，都要忽視。若寫了 `limit: n` 表示第一次 `REQ` 之後，將取得最新的 `n` 筆事件資料。如果給出的資料數少於 `n` 也可以。但是，中繼站不可以送回超過 `limit` 指定的資料數量，以確保客戶端不必為了超量的查詢結果而困擾。

### 從中繼端到客戶端：發送事件與提醒

中繼端可以送二種訊息，每一種訊息必須是 JSON 陣列。有下列格式：

  * `["EVENT", 「訊息訂閱代碼 subscription_id」, 「如上定義的事件物件 JSON」]`，用來發送事件給客戶端。
  * `["NOTICE", 「訊息」]`，用來發送人可閱讀的錯誤訊息給客戶端；也可以帶有其他內容。

對 `NOTICE` 訊息應該帶什麼內容，要怎麼處理，本文不規定任何規則。

`EVENT` 訊息必須只為先前曾用 `REQ` 訊息開始訂閱的客戶端，也就是照著`訊息訂閱代碼 subscription_id` 送回符合過濾規則的事件給該客戶端。

## 基本事件種類

  - `0`: 登記身份資料。`set_metadata`：此時 `content` 欄位是一個字面化的 JSON 物件 `{name: 「使用者名稱」, about: 「文字」, picture: 「圖片網址」}` ，內容陳明發送該事件的使用者資料。中繼站可以依相同的 pubkey 而當收到新的 `set_metadata` 時，即將舊的 `set_metadata` 事件刪除。
    - `1`: 文字內容。`text_note`：此時 `content` 欄位是文字記載，即任何使用者想說的話。非文字記載的內容，應改用 1000 到 10000 之間的 `kind` ，如 [NIP-16](16.md) 所述。
  - `2`: 推薦的中繼站址。`recommend_server`：此時 `content` 欄位放一筆中繼站址，表示使用者推薦一個中繼站給他的粉絲使用。

中繼站可以對每一種事件採取不同的處置。或者，如果中繼站遇到不懂的事件種類，可以安排一種共通預定的處理方式。

## 附註

- 客戶端對每一個中繼站不該拉第二條 websocket 連線。一條通道可以支撐無限多訂閱次，所以，客戶端應該要如此善用通道。
- `tags` 陣列可以給每一條子項陣列開頭放一個標籤識別符號，並在該符號之後附帶任意資訊（都要是文字）。本文指定 `"p"` 符號代表 "pubkey"，對照到某位使用者的 pubkey ，表示跟該事件有關的人。而指定 `"e"` 代表 "event"，對照到由該事件援引的另一個事件，無論是該事件對另一個事件屬訊息回覆關係，或該事件以另一個事件為附註之類，各種情況。
- 標籤 `"e"` 與標籤 `"p"` 的`推薦的中繼站址`，是讓客戶端可以試著去連連看的備用網址。客戶端可以透過標籤區列出的東西，再去抓到其中標記的事件與個人資料。或可忽略那些資訊。但是，這些標籤種類，可用來幫助抵抗內容審查，或順道使中繼站址廣泛發送給更多客戶端知曉。
